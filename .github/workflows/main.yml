name: Deploy Strapi to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'  # Use the Node.js version compatible with Strapi

    - name: Install dependencies
      run: npm install

    - name: Build Strapi
      run: NODE_OPTIONS="--max_old_space_size=8192" npm run build


    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: strapi-build
        path: build/

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: strapi-build
        path: build/

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          pm2 stop strapi || true
          cd /home/${{ secrets.EC2_USER }}/my-strapi-api
          rm -rf build
          mkdir -p build
          rsync -avz -e "ssh -i /home/${{ secrets.EC2_USER }}/.ssh/id_rsa" build/ /home/${{ secrets.EC2_USER }}/my-strapi-api/build/
          npm install --production
          pm2 start npm --name "strapi" -- run start
